name: AI Code Review

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Collect code diff safely
        run: |
          set +e
          git fetch origin main

          # Try PR diff
          git diff origin/main...HEAD > diff.txt 2>/dev/null

          # Fallback to last commit if no merge base
          if [ $? -ne 0 ] || [ ! -s diff.txt ]; then
            echo "Using last commit diff"
            git diff HEAD~1 > diff.txt || true
          fi

          # Final fallback
          if [ ! -s diff.txt ]; then
            echo "No code changes detected" > diff.txt
          fi

          echo "=== DIFF CONTENT ==="
          cat diff.txt

      - name: Build Lambda payload (JSON-safe)
         run: |
    python - <<EOF
    import json

    try:
        with open("diff.txt", "r", encoding="utf-8", errors="ignore") as f:
            diff = f.read()
    except FileNotFoundError:
        diff = "No diff found"

    payload = {
        "files": [
            {
                "filename": "git-diff.txt",
                "content": diff[:12000]
            }
        ]
    }

    with open("payload.json", "w", encoding="utf-8") as f:
        json.dump(payload, f)

    print("Payload created successfully")
    EOF


      - name: Invoke AI Code Review Lambda
        run: |
          aws lambda invoke \
            --function-name ai-code-review-lambda \
            --payload file://payload.json \
            response.json

          echo "=== LAMBDA RESPONSE ==="
          cat response.json

      - name: Extract PDF URL safely
        run: |
          python - <<EOF
          import json, sys

          with open("response.json", "r", encoding="utf-8", errors="ignore") as f:
              data = json.load(f)

          body = data.get("body")
          if not body:
              print("No body returned")
              sys.exit(0)

          if isinstance(body, str):
              body = json.loads(body)

          pdf = body.get("pdf_url")
          if not pdf:
              print("No PDF URL")
              sys.exit(0)

          with open("pdf_url.txt", "w") as f:
              f.write(pdf)

          print("PDF URL:", pdf)
          EOF

      - name: Post PDF link as PR comment
        if: github.event_name == 'pull_request'
        run: |
          if [ ! -f pdf_url.txt ]; then
            echo "No PDF to post"
            exit 0
          fi

          PDF_URL=$(cat pdf_url.txt)

          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "{\"body\": \"ðŸ§  **AI Code Review Report**\\n\\nðŸ“„ PDF: $PDF_URL\"}"
